---
name: Update AUR Package

"on":
  release:
    types: [published]
  repository_dispatch:
    types: [release-orchestrator]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  update-aur:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

          # Create SSH config for AUR
          cat > ~/.ssh/config <<EOF
          Host aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/aur
            StrictHostKeyChecking yes
          EOF

      - name: Calculate release checksums
        id: checksums
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version="${{ github.event.release.tag_name ||
            github.event.inputs.version ||
            github.event.client_payload.version }}"
          version="${version#v}"

          # Download release files to calculate checksums
          gh release download "v${version}" --repo sourcegraph/amp-packages \
            --pattern "amp-linux-x64" --pattern "amp-linux-arm64"

          # Calculate SHA256 checksums
          amd64_sha=$(sha256sum amp-linux-x64 | cut -d' ' -f1)
          arm64_sha=$(sha256sum amp-linux-arm64 | cut -d' ' -f1)

          echo "amd64_sha=$amd64_sha" >> $GITHUB_OUTPUT
          echo "arm64_sha=$arm64_sha" >> $GITHUB_OUTPUT

          # Clean up
          rm amp-linux-*

      - name: Update local PKGBUILD first
        run: |
          version="${{ github.event.release.tag_name ||
            github.event.inputs.version ||
            github.event.client_payload.version }}"
          version="${version#v}"

          # Update local PKGBUILD with version and checksums
          cp aur/amp-bin/PKGBUILD aur/amp-bin/PKGBUILD.bak
          sed -i "s/REPLACE_WITH_VERSION/$version/g" aur/amp-bin/PKGBUILD
          sed -i "s/REPLACE_WITH_LINUX_AMD64_SHA256/${{ steps.checksums.outputs.amd64_sha }}/g" aur/amp-bin/PKGBUILD
          sed -i "s/REPLACE_WITH_LINUX_ARM64_SHA256/${{ steps.checksums.outputs.arm64_sha }}/g" aur/amp-bin/PKGBUILD

      - name: Clone and update AUR package
        run: |
          version="${{ github.event.release.tag_name ||
            github.event.inputs.version ||
            github.event.client_payload.version }}"
          version="${version#v}"

          # Clone AUR repository
          git clone ssh://aur@aur.archlinux.org/amp-bin.git aur-repo
          cd aur-repo

          # Copy our updated PKGBUILD to the AUR repo
          cp ../aur/amp-bin/PKGBUILD ./PKGBUILD

          # Generate new .SRCINFO
          makepkg --printsrcinfo > .SRCINFO

          # Configure git
          git config user.name "Amp"
          git config user.email "amp@ampcode.com"

          # Commit and push changes
          git add PKGBUILD .SRCINFO
          git commit -m "Update to version $version

          - Update pkgver to $version
          - Update download URLs for new release
          - Update SHA256 checksums for x86_64 and aarch64

          Automated update from GitHub Actions"

          git push origin master

      - name: Update local AUR files
        run: |
          version="${{ github.event.release.tag_name ||
            github.event.inputs.version ||
            github.event.client_payload.version }}"
          version="${version#v}"

          # Copy updated files back to our repository
          cp aur-repo/PKGBUILD aur/amp-bin/PKGBUILD
          cp aur-repo/.SRCINFO aur/amp-bin/.SRCINFO

          # Update local repository
          git config --local user.email "amp@ampcode.com"
          git config --local user.name "Amp"
          git add aur/amp-bin/
          git commit -m "Update AUR package to $version with checksums" ||
            exit 0
          git push
